<body>
<pre>
/**
	Simple TCP client to fetch a web page
	Silver Moon (m00n.silv3r@gmail.com)
	https://www.binarytides.com/receive-full-data-with-recv-socket-function-in-c/
*/

#include&lt;stdio.h&gt;	//printf
#include&lt;string.h&gt;	//strlen
#include&lt;sys/socket.h&gt;	//socket
#include&lt;arpa/inet.h&gt;	//inet_addr
#include&lt;unistd.h&gt;	//usleep
#include&lt;fcntl.h&gt;	//fcntl

//Size of each chunk of data received, try changing this
#define CHUNK_SIZE 512

//Receiving function
int recv_timeout(int s, int timeout);

int main(int argc , char *argv[])
{
	int socket_desc;
	struct sockaddr_in server;
	char *message , server_reply[2000];
	
	//Create socket
	socket_desc = socket(AF_INET , SOCK_STREAM , 0);
	if (socket_desc == -1)
	{
		printf(&quot;Could not create socket&quot;);
	}
	
	//ip address of www.msn.com (get by doing a ping www.msn.com at terminal)
	server.sin_addr.s_addr = inet_addr(&quot;131.253.13.140&quot;);
	server.sin_family = AF_INET;
	server.sin_port = htons( 80 );

	//Connect to remote server
	if (connect(socket_desc , (struct sockaddr *)&amp;server , sizeof(server)) &lt; 0)
	{
		puts(&quot;connect error&quot;);
		return 1;
	}
	
	puts(&quot;Connected\n&quot;);
	
	//Send some data
	message = &quot;GET /?st=1 HTTP/1.1\r\nHost: www.msn.com\r\n\r\n&quot;;
	if( send(socket_desc , message , strlen(message) , 0) &lt; 0)
	{
		puts(&quot;Send failed&quot;);
		return 1;
	}
	puts(&quot;Data Send\n&quot;);
	
	//Now receive full data
	int total_recv = recv_timeout(socket_desc, 4);
	
	printf(&quot;\n\nDone. Received a total of %d bytes\n\n&quot; , total_recv);
	return 0;
}

/*
	Receive data in multiple chunks by checking a non-blocking socket
	Timeout in seconds
*/
int recv_timeout(int s , int timeout)
{
	int size_recv , total_size= 0;
	struct timeval begin , now;
	char chunk[CHUNK_SIZE];
	double timediff;
	
	//make socket non blocking
	fcntl(s, F_SETFL, O_NONBLOCK);
	
	//beginning time
	gettimeofday(&amp;begin , NULL);
	
	while(1)
	{
		gettimeofday(&amp;now , NULL);
		
		//time elapsed in seconds
		timediff = (now.tv_sec - begin.tv_sec) + 1e-6 * (now.tv_usec - begin.tv_usec);
		
		//if you got some data, then break after timeout
		if( total_size &gt; 0 &amp;&amp; timediff &gt; timeout )
		{
			break;
		}
		
		//if you got no data at all, wait a little longer, twice the timeout
		else if( timediff &gt; timeout*2)
		{
			break;
		}
		
		memset(chunk ,0 , CHUNK_SIZE);	//clear the variable
		if((size_recv =  recv(s , chunk , CHUNK_SIZE , 0) ) &lt; 0)
		{
			//if nothing was received then we want to wait a little before trying again, 0.1 seconds
			usleep(100000);
		}
		else
		{
			total_size += size_recv;
			printf(&quot;%s&quot; , chunk);
			//reset beginning time
			gettimeofday(&amp;begin , NULL);
		}
	}
	
	return total_size;
}
</pre>
</body>
