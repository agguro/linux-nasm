     1                                  ; Name        : dynamiclistview.asm
     2                                  ;
     3                                  ; Build       : nasm -felf64 -o dynamiclistview.o -l dynamiclistview.lst dynamiclistview.asm
     4                                  ;               ld --dynamic-linker /lib64/ld-linux-x86-64.so.2 -melf_x86_64 -g -o dynamiclistview dynamiclistview.o -lc -lgtk-x11-2.0 -lgdk-x11-2.0 -lgobject-2.0 -lgdk_pixbuf-2.0 -lglib-2.0
     5                                  ;               cd build
     6                                  ;               ../configure
     7                                  ;               make
     8                                  ;
     9                                  ; Description : a listview with some functionality
    10                                  ;               debugging the C source reveals that only register rbx can be
    11                                  ;               used in a safe way to store the value of the label pointer in
    12                                  ;               the on_changed event routine.
    13                                  ; Source      : http://zetcode.com/gui/gtk2/gtktreeview/ (listview.c)
    14                                  
    15                                  bits 64
    16                                  
    17                                  [list -]
    58                                  
    59                                  section .rodata
    60 00000000 6C6973742076696577-         szTitle:      db    "list view",0
    60 00000009 00                 
    61 0000000A 64657374726F7900            szDestroy:    db    "destroy",0
    62 00000012 6368616E67656400            szChanged:    db    "changed",0
    63 0000001A 00                          szLabel:      db    "",0
    64 0000001B 416C69656E7300              szAliens:       db  "Aliens",0
    65 00000022 4C656F6E00                  szLeon:         db  "Leon",0
    66 00000027 4E6F72746820666163-         szNorthFace:    db  "North face",0
    66 00000030 6500               
    67 00000032 546865207665726469-         szTheVerdict:   db  "The verdict",0
    67 0000003B 637400             
    68 0000003E 44657220556E746572-         szDerUntergang: db  "Der Untergang",0
    68 00000047 67616E6700         
    69 0000004C 7465787400                  szText:         db  "text",0
    70 00000051 4C697374204974656D-         szListItems:    db  "List Items",0
    70 0000005A 7300               
    71                                   
    72                                  section .bss   
    73 00000000 ????????????????            model:        resq  1
    74 00000008 ????????????????            value:        resq  1
    75 00000010 ????????????????            iter:         resq  1
    76 00000018 ????????????????            selectiter:   resq  1
    77 00000020 ????????????????            window:       resq  1
    78 00000028 ????????????????            list:         resq  1
    79 00000030 ????????????????            vbox:         resq  1
    80 00000038 ????????????????            label:        resq  1
    81 00000040 ????????????????            selection:    resq  1
    82 00000048 ????????????????            renderer:     resq  1
    83 00000050 ????????????????            column:       resq  1
    84 00000058 ????????????????            store:        resq  1
    85 00000060 ????????????????            liststore:    resq  1
    86                                  
    87                                  section .text
    88                                  global _start
    89                                  
    90                                  _start:
    91                                      ;init gtk
    92 00000000 4831FF                      xor     rdi,rdi                 
    93 00000003 4831F6                      xor     rsi,rsi
    94 00000006 E8(00000000)                call    gtk_init
    95                                      ;create a new window
    96 0000000B BF00000000                  mov     rdi,GTK_WINDOW_TOPLEVEL
    97 00000010 E8(00000000)                call    gtk_window_new
    98 00000015 48890425[20000000]          mov     qword[window],rax
    99 0000001D E8(00000000)                call    gtk_tree_view_new
   100 00000022 48890425[28000000]          mov     qword[list],rax
   101                                      ;set the title
   102 0000002A 488B3C25[20000000]          mov     rdi,qword[window]
   103 00000032 48BE-                       mov     rsi,szTitle
   103 00000034 [0000000000000000] 
   104 0000003C E8(00000000)                call    gtk_window_set_title
   105                                  
   106 00000041 488B3C25[20000000]          mov     rdi,qword[window]
   107 00000049 BE01000000                  mov     rsi,GTK_WIN_POS_CENTER
   108 0000004E E8(00000000)                call    gtk_window_set_position
   109 00000053 488B3C25[20000000]          mov     rdi,qword[window]
   110 0000005B BE0A000000                  mov     rsi,10
   111 00000060 E8(00000000)                call    gtk_container_set_border_width
   112 00000065 488B3C25[20000000]          mov     rdi,qword[window]
   113 0000006D BE0E010000                  mov     rsi,270
   114 00000072 BAFA000000                  mov     rdx,250
   115 00000077 E8(00000000)                call    gtk_window_set_default_size
   116 0000007C 488B3C25[28000000]          mov     rdi,qword[list]
   117 00000084 BE00000000                  mov     rsi,FALSE
   118 00000089 E8(00000000)                call    gtk_tree_view_set_headers_visible
   119 0000008E BF00000000                  mov     rdi,FALSE
   120 00000093 BE00000000                  mov     rsi,0
   121 00000098 E8(00000000)                call    gtk_vbox_new
   122 0000009D 48890425[30000000]          mov     qword[vbox],rax
   123 000000A5 488B3C25[30000000]          mov     rdi,qword[vbox]
   124 000000AD 488B3425[28000000]          mov     rsi,qword[list]
   125 000000B5 BA01000000                  mov     rdx,TRUE
   126 000000BA B901000000                  mov     rcx,TRUE
   127 000000BF 41B805000000                mov     r8,5
   128 000000C5 4D31C9                      xor     r9,r9
   129 000000C8 E8(00000000)                call    gtk_box_pack_start
   130 000000CD 48BF-                       mov     rdi,szLabel
   130 000000CF [1A00000000000000] 
   131 000000D7 E8(00000000)                call    gtk_label_new
   132 000000DC 48890425[38000000]          mov     qword[label],rax
   133 000000E4 488B3C25[30000000]          mov     rdi,qword[vbox]
   134 000000EC 488B3425[38000000]          mov     rsi,qword[label]
   135 000000F4 BA00000000                  mov     rdx,FALSE
   136 000000F9 B900000000                  mov     rcx,FALSE
   137 000000FE 41B805000000                mov     r8,5
   138 00000104 4D31C9                      xor     r9,r9
   139 00000107 E8(00000000)                call    gtk_box_pack_start
   140 0000010C 488B3C25[20000000]          mov     rdi,qword[window]
   141 00000114 488B3425[30000000]          mov     rsi,qword[vbox]
   142 0000011C E8(00000000)                call    gtk_container_add
   143                                  
   144                                      ;we only have one list so we can use the global variable
   145 00000121 E840010000                  call    init_list
   146 00000126 48BF-                       mov     rdi,szAliens
   146 00000128 [1B00000000000000] 
   147 00000130 E8C3010000                  call    add_to_list
   148 00000135 48BF-                       mov     rdi,szLeon
   148 00000137 [2200000000000000] 
   149 0000013F E8B4010000                  call    add_to_list
   150 00000144 48BF-                       mov     rdi,szTheVerdict
   150 00000146 [3200000000000000] 
   151 0000014E E8A5010000                  call    add_to_list   
   152 00000153 48BF-                       mov     rdi,szNorthFace
   152 00000155 [2700000000000000] 
   153 0000015D E896010000                  call    add_to_list
   154 00000162 48BF-                       mov     rdi,szDerUntergang
   154 00000164 [3E00000000000000] 
   155 0000016C E887010000                  call    add_to_list
   156                                   
   157 00000171 488B3C25[28000000]          mov     rdi,qword[list]
   158 00000179 E8(00000000)                call    gtk_tree_view_get_selection
   159 0000017E 48890425[40000000]          mov     qword[selection],rax
   160                                  
   161                                  section .text
   162                                      ;connect the changed signal to on_changed event handler
   163 00000186 4531C9                      xor     r9d,r9d                    ; combination of GConnectFlags 
   164 00000189 4531C0                      xor     r8d,r8d                    ; a GClosureNotify for data
   165 0000018C 488B0C25[38000000]          mov     rcx,qword[label]             ; pointer to the data to pass
   166 00000194 48BA-                       mov     rdx,on_changed             ; pointer to the handler
   166 00000196 [F901000000000000] 
   167 0000019E 48BE-                       mov     rsi,szChanged              ; pointer to the signal
   167 000001A0 [1200000000000000] 
   168 000001A8 488B3C25[40000000]          mov     rdi,qword[selection]       ; pointer to the widget instance
   169                                      ;C programs uses g_signal_connect, this is not a library function.
   170 000001B0 E8(00000000)                call    g_signal_connect_data
   171                                  
   172                                      ;connect the destroy signal to gtk_main_quit event handler
   173 000001B5 4531C9                      xor     r9d,r9d                    ; combination of GConnectFlags 
   174 000001B8 4531C0                      xor     r8d,r8d                    ; a GClosureNotify for data
   175 000001BB 4831C9                      xor     rcx,rcx                    ; pointer to the data to pass
   176 000001BE 48BA-                       mov     rdx,gtk_main_quit          ; pointer to the handler
   176 000001C0 [0000000000000000] 
   177 000001C8 48BE-                       mov     rsi,szDestroy              ; pointer to the signal
   177 000001CA [0A00000000000000] 
   178 000001D2 488B3C25[20000000]          mov     rdi,qword[window]          ; pointer to the widget instance
   179                                      ;C programs uses g_signal_connect, this is not a library function.
   180 000001DA E8(00000000)                call    g_signal_connect_data
   181                                  
   182                                      ;show the window
   183 000001DF 488B3C25[20000000]          mov     rdi,qword[window]
   184 000001E7 E8(00000000)                call    gtk_widget_show_all
   185                                      ;go into applications main loop
   186 000001EC E8(00000000)                call    gtk_main
   187                                  .exit:    
   188                                      ;exit program
   189 000001F1 4831FF                      xor     rdi,rdi
   190 000001F4 E8(00000000)                call    exit
   191                                  
   192                                  on_changed:
   193                                      ;rdi has the pointer to the widget pointer
   194                                      ;rsi has the pointer to the label
   195 000001F9 55                          push    rbp
   196 000001FA 4889F3                      mov     rbx,rsi                             ;we can use rbx safely
   197 000001FD 48BE-                       mov     rsi,model
   197 000001FF [0000000000000000] 
   198 00000207 48BA-                       mov     rdx,selectiter
   198 00000209 [1800000000000000] 
   199 00000211 E8(00000000)                call    gtk_tree_selection_get_selected
   200 00000216 4885C0                      test    rax,rax
   201 00000219 7449                        je      .done
   202                                  
   203 0000021B 488B3C25[00000000]          mov     rdi,qword[model]
   204 00000223 48BE-                       mov     rsi,selectiter
   204 00000225 [1800000000000000] 
   205 0000022D BA00000000                  mov     rdx,LIST_ITEM
   206 00000232 48B9-                       mov     rcx,value
   206 00000234 [0800000000000000] 
   207 0000023C 41B8FFFFFFFF                mov     r8d,-1
   208 00000242 E8(00000000)                call    gtk_tree_model_get
   209                                  
   210 00000247 4889DF                      mov     rdi,rbx
   211 0000024A 488B3425[08000000]          mov     rsi,qword[value]
   212 00000252 E8(00000000)                call    gtk_label_set_text
   213                                  
   214 00000257 488B3C25[08000000]          mov     rdi,qword[value]
   215 0000025F E8(00000000)                call    g_free
   216                                    .done:
   217 00000264 5D                          pop     rbp
   218 00000265 C3                          ret
   219                                   
   220                                  
   221                                  init_list:
   222                                      ;normally rdi has the pointer to the list, because we have only one list we use the global variable
   223 00000266 55                          push    rbp
   224 00000267 E8(00000000)                call    gtk_cell_renderer_text_new
   225 0000026C 48890425[48000000]          mov     qword[renderer],rax
   226 00000274 48BF-                       mov     rdi,szListItems
   226 00000276 [5100000000000000] 
   227 0000027E 488B3425[48000000]          mov     rsi,qword[renderer]
   228 00000286 48BA-                       mov     rdx,szText
   228 00000288 [4C00000000000000] 
   229 00000290 B900000000                  mov     rcx,LIST_ITEM
   230 00000295 4D31C0                      xor     r8,r8
   231 00000298 4D31C9                      xor     r9,r9
   232 0000029B E8(00000000)                call    gtk_tree_view_column_new_with_attributes
   233 000002A0 48890425[50000000]          mov     qword[column],rax
   234 000002A8 488B3C25[28000000]          mov     rdi,qword[list]
   235 000002B0 488B3425[50000000]          mov     rsi,qword[column]
   236 000002B8 E8(00000000)                call    gtk_tree_view_append_column
   237 000002BD BF01000000                  mov     rdi,N_COLUMNS
   238 000002C2 BE40000000                  mov     rsi,G_TYPE_STRING
   239 000002C7 E8(00000000)                call    gtk_list_store_new
   240 000002CC 48890425[58000000]          mov     qword[store],rax
   241 000002D4 488B3C25[28000000]          mov     rdi,qword[list]
   242 000002DC 488B3425[58000000]          mov     rsi,qword[store]
   243 000002E4 E8(00000000)                call    gtk_tree_view_set_model
   244 000002E9 488B3C25[58000000]          mov     rdi,qword[store]
   245 000002F1 E8(00000000)                call    g_object_unref
   246 000002F6 5D                          pop     rbp
   247 000002F7 C3                          ret
   248                                  
   249                                  add_to_list:
   250                                      ;pointer to listitem string in rdi
   251 000002F8 55                          push    rbp
   252 000002F9 4889FB                      mov     rbx,rdi                              ;save pointer to listitem string
   253 000002FC 488B3C25[28000000]          mov     rdi,qword[list]
   254 00000304 E8(00000000)                call    gtk_tree_view_get_model
   255 00000309 48890425[60000000]          mov     qword[liststore],rax
   256 00000311 488B3C25[60000000]          mov     rdi,qword[liststore]
   257 00000319 48BE-                       mov     rsi,iter
   257 0000031B [1000000000000000] 
   258 00000323 E8(00000000)                call    gtk_list_store_append
   259 00000328 488B3C25[60000000]          mov     rdi,qword[liststore]
   260 00000330 48BE-                       mov     rsi,iter
   260 00000332 [1000000000000000] 
   261 0000033A BA00000000                  mov     rdx,LIST_ITEM
   262 0000033F 4889D9                      mov     rcx,rbx
   263 00000342 41B8FFFFFFFF                mov     r8d,-1
   264 00000348 E8(00000000)                call    gtk_list_store_set
   265 0000034D 5D                          pop     rbp
   266 0000034E C3                          ret
