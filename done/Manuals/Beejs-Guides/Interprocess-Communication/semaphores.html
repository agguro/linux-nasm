<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>Beej's Guide to Interprocess Communication</title>
  <style>
    html {
      line-height: 1.5;
      font-family: Georgia, serif;
      font-size: 20px;
      color: #1a1a1a;
      background-color: #fdfdfd;
    }
    body {
      margin: 0 auto;
      max-width: 36em;
      padding-left: 50px;
      padding-right: 50px;
      padding-top: 50px;
      padding-bottom: 50px;
      hyphens: auto;
      overflow-wrap: break-word;
      text-rendering: optimizeLegibility;
      font-kerning: normal;
    }
    @media (max-width: 600px) {
      body {
        font-size: 0.9em;
        padding: 1em;
      }
      h1 {
        font-size: 1.8em;
      }
    }
    @media print {
      body {
        background-color: transparent;
        color: black;
        font-size: 12pt;
      }
      p, h2, h3 {
        orphans: 3;
        widows: 3;
      }
      h2, h3, h4 {
        page-break-after: avoid;
      }
    }
    p {
      margin: 1em 0;
    }
    a {
      color: #1a1a1a;
    }
    a:visited {
      color: #1a1a1a;
    }
    img {
      max-width: 100%;
    }
    h1, h2, h3, h4, h5, h6 {
      margin-top: 1.4em;
    }
    h5, h6 {
      font-size: 1em;
      font-style: italic;
    }
    h6 {
      font-weight: normal;
    }
    ol, ul {
      padding-left: 1.7em;
      margin-top: 1em;
    }
    li > ol, li > ul {
      margin-top: 0;
    }
    blockquote {
      margin: 1em 0 1em 1.7em;
      padding-left: 1em;
      border-left: 2px solid #e6e6e6;
      color: #606060;
    }
    code {
      font-family: Menlo, Monaco, 'Lucida Console', Consolas, monospace;
      font-size: 85%;
      margin: 0;
    }
    pre {
      margin: 1em 0;
      overflow: auto;
    }
    pre code {
      padding: 0;
      overflow: visible;
      overflow-wrap: normal;
    }
    .sourceCode {
     background-color: transparent;
     overflow: visible;
    }
    hr {
      background-color: #1a1a1a;
      border: none;
      height: 1px;
      margin: 1em 0;
    }
    table {
      margin: 1em 0;
      border-collapse: collapse;
      width: 100%;
      overflow-x: auto;
      display: block;
      font-variant-numeric: lining-nums tabular-nums;
    }
    table caption {
      margin-bottom: 0.75em;
    }
    tbody {
      margin-top: 0.5em;
      border-top: 1px solid #1a1a1a;
      border-bottom: 1px solid #1a1a1a;
    }
    th {
      border-top: 1px solid #1a1a1a;
      padding: 0.25em 0.5em 0.25em 0.5em;
    }
    td {
      padding: 0.125em 0.5em 0.25em 0.5em;
    }
    header {
      margin-bottom: 4em;
      text-align: center;
    }
    #TOC li {
      list-style: none;
    }
    #TOC ul {
      padding-left: 1.3em;
    }
    #TOC > ul {
      padding-left: 0;
    }
    #TOC a:not(:hover) {
      text-decoration: none;
    }
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    div.columns{display: flex; gap: min(4vw, 1.5em);}
    div.column{flex: auto; overflow-x: auto;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
    ul.task-list li input[type="checkbox"] {
      width: 0.8em;
      margin: 0 0.8em 0.2em -1.6em;
      vertical-align: middle;
    }
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    .sourceCode { overflow: visible; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      {   }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span.al { color: #ff0000; font-weight: bold; } /* Alert */
    code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
    code span.at { color: #7d9029; } /* Attribute */
    code span.bn { color: #40a070; } /* BaseN */
    code span.bu { color: #008000; } /* BuiltIn */
    code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #4070a0; } /* Char */
    code span.cn { color: #880000; } /* Constant */
    code span.co { color: #60a0b0; font-style: italic; } /* Comment */
    code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
    code span.do { color: #ba2121; font-style: italic; } /* Documentation */
    code span.dt { color: #902000; } /* DataType */
    code span.dv { color: #40a070; } /* DecVal */
    code span.er { color: #ff0000; font-weight: bold; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #40a070; } /* Float */
    code span.fu { color: #06287e; } /* Function */
    code span.im { color: #008000; font-weight: bold; } /* Import */
    code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
    code span.kw { color: #007020; font-weight: bold; } /* Keyword */
    code span.op { color: #666666; } /* Operator */
    code span.ot { color: #007020; } /* Other */
    code span.pp { color: #bc7a00; } /* Preprocessor */
    code span.sc { color: #4070a0; } /* SpecialChar */
    code span.ss { color: #bb6688; } /* SpecialString */
    code span.st { color: #4070a0; } /* String */
    code span.va { color: #19177c; } /* Variable */
    code span.vs { color: #4070a0; } /* VerbatimString */
    code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
  <link href="https://fonts.googleapis.com/css?family=Roboto|Roboto+Mono&display=swap" rel="stylesheet"> 

  <!-- BG custom styling -->
  <style type="text/css">
  /* Fix for line numbers not visible */
  pre.numberSource code > span {
      left: -1em;
  }
  pre.numberSource {
      margin-left: initial;
  }

  /* Put some space after the section numbers */
  span.toc-section-number::after {
      content: "\a0\a0\a0";  /* non-breaking whitespace */
  }

  /* Hide underlines on code number links */
  pre > code.sourceCode > span > a:first-child::before {
      text-decoration: none;
  }

  /* Color the source blocks */
  div.sourceCode {
      background-color: #f0f0f0;
  }

  /* Fix iOS big text rendering issue */
  pre > code.sourceCode > span {
      display: initial;
  }


  /* Color the inline code */
  code:not(.sourceCode) {
      background: #f0f0f0;
      padding-left: 0.2em;
      padding-right: 0.2em;
      border-radius: 0.2em;
  }

  /* Keep code tags from wrapping in tables */
  tbody code {
      white-space: nowrap;
  }

  td {
      vertical-align: top;
  }

  body {
      font-size: 12pt;
      max-width: 43em;
  }

  figure {
      text-align: center;
  }
  </style>
  <!-- BG custom styling for the wide body variant -->
  <!-- Gets appended after bg-css.html -->

  <style type="text/css">
  body {
      max-width: inherit;
  }
  </style>
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
</head>
<body>
<div style="text-align:center"><span><a href="mq.html">Prev</a> | </span><a href="index.html">Contents</a><span> | <a href="shm.html">Next</a></span></div><hr>
<h1 data-number="8" id="semaphores"><span class="header-section-number">8</span> Semaphores</h1>
<p>Remember <a href="flocking.html#flocking">file locking</a>? Well, semaphores can be thought of as really generic advisory locking mechanisms. You can use them to control access to files, <a href="shm.html#shm">shared memory</a>, and, well, just about anything you want. The basic functionality of a semaphore is that you can either set it, check it, or wait until it clears then set it (“test-n-set”). No matter how complex the stuff that follows gets, remember those three operations.</p>
<p>This document will provide an overview of semaphore functionality, and will end with a program that uses semaphores to control access to a file. (This task, admittedly, could easily be handled with file locking, but it makes a good example since it’s easier to wrap your head around than, say, shared memory.)</p>
<!-- ======================================================= -->
<!-- Grabbing some semaphores -->
<!-- ======================================================= -->
<h2 data-number="8.1" id="grabbing-some-semaphores"><span class="header-section-number">8.1</span> Grabbing some semaphores</h2>
<p>With System V IPC, you don’t grab single semaphores; you grab <em>sets</em> of semaphores. You can, of course, grab a semaphore set that only has one semaphore in it, but the point is you can have a whole slew of semaphores just by creating a single semaphore set.</p>
<p>How do you create the semaphore set? It’s done with a call to <code>semget()</code>, which returns the semaphore id (hereafter referred to as the <code>semid</code>):</p>
<div class="sourceCode" id="cb40"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb40-1"><a href="semaphores.html#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;sys/sem.h&gt;</span></span>
<span id="cb40-2"><a href="semaphores.html#cb40-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-3"><a href="semaphores.html#cb40-3" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> semget<span class="op">(</span>key_t key<span class="op">,</span> <span class="dt">int</span> nsems<span class="op">,</span> <span class="dt">int</span> semflg<span class="op">);</span></span></code></pre></div>
<p>What’s the <code>key</code>? It’s a unique identifier that is used by different processes to identify this semaphore set. (This <code>key</code> will be generated using <code>ftok()</code>, described in the <a href="mq.html#mqftok">Message Queues section</a>.)</p>
<p>The next argument, <code>nsems</code>, is (you guessed it!) the number of semaphores in this semaphore set. The maximum number is system dependent, but it’s probably around 32000. If you’re needing more (greedy wretch!), just get another semaphore set. You may pass <code>0</code> if you’re connecting to an existing semaphore set, but you must specify a positive number if you’re creating a new semaohore set.</p>
<p>Finally, there’s the <code>semflg</code> argument. This tells <code>semget()</code> what the permissions should be on the new semaphore set, whether you’re creating a new set or just want to connect to an existing one, and other things that you can look up. For creating a new set, permissions can be bitwise-OR’d with <code>IPC_CREAT</code>.</p>
<p>Here’s an example call that generates the <code>key</code> with <code>ftok()</code> and creates a 10 semaphore set, with 666 (<code>rw-rw-rw-</code>) permissions:</p>
<div class="sourceCode" id="cb41"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb41-1"><a href="semaphores.html#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;sys/ipc.h&gt;</span></span>
<span id="cb41-2"><a href="semaphores.html#cb41-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;sys/sem.h&gt;</span></span>
<span id="cb41-3"><a href="semaphores.html#cb41-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-4"><a href="semaphores.html#cb41-4" aria-hidden="true" tabindex="-1"></a>key_t key<span class="op">;</span></span>
<span id="cb41-5"><a href="semaphores.html#cb41-5" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> semid<span class="op">;</span></span>
<span id="cb41-6"><a href="semaphores.html#cb41-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-7"><a href="semaphores.html#cb41-7" aria-hidden="true" tabindex="-1"></a>key <span class="op">=</span> ftok<span class="op">(</span><span class="st">&quot;/home/beej/somefile&quot;</span><span class="op">,</span> <span class="ch">&#39;E&#39;</span><span class="op">);</span></span>
<span id="cb41-8"><a href="semaphores.html#cb41-8" aria-hidden="true" tabindex="-1"></a>semid <span class="op">=</span> semget<span class="op">(</span>key<span class="op">,</span> <span class="dv">10</span><span class="op">,</span> <span class="bn">0666</span> <span class="op">|</span> IPC_CREAT<span class="op">);</span></span></code></pre></div>
<p>Congrats! You’ve created a new semaphore set! After running the program you can check it out with the <code>ipcs</code> command. (Don’t forget to remove it when you’re done with it with <code>ipcrm</code>!)</p>
<p>Wait! Warning! <em>¡Advertencia! ¡No pongas las manos en la tolva!</em> (That’s the only Spanish I learned while working at Pizza Hut in 1990. It was printed on the dough roller.) Look here:</p>
<p>When you first create some semaphores, they’re all uninitialized; it takes another call to mark them as free (namely to <code>semop()</code> or <code>semctl()</code>—see the following sections.) What does this mean? Well, it means that creation of a semaphore is not <em>atomic</em> (in other words, it’s not a one-step process). If two processes are trying to create, initialize, and use a semaphore at the same time, a race condition might develop.</p>
<p>One way to get around this difficulty is by having a single init process that creates and initializes the semaphore long before the main processes begin to run. The main process just accesses it, but never creates nor destroys it.</p>
<p>Stevens refers to this problem as the semaphore’s “fatal flaw”. He solves it by creating the semaphore set with the <code>IPC_EXCL</code> flag. If process 1 creates it first, process 2 will return an error on the call (with <code>errno</code> set to <code>EEXIST</code>.) At that point, process 2 will have to wait until the semaphore is initialized by process 1. How can it tell? Turns out, it can repeatedly call <code>semctl()</code> with the <code>IPC_STAT</code> flag, and look at the <code>sem_otime</code> member of the returned <code>struct semid_ds</code> structure. If that’s non-zero, it means process 1 has performed an operation on the semaphore with <code>semop()</code>, presumably to initialize it.</p>
<p>For an example of this, see the demonstration program <a href="https://beej.us/guide/bgipc/source/examples/semdemo.c"><code>semdemo.c</code></a><a href="footnotes.html#fn33" class="footnote-ref" id="fnref33" role="doc-noteref"><sup>33</sup></a>, below, in which I generally reimplement <a href="http://www.kohala.com/start/unpv22e/unpv22e.html">Stevens’s code</a>.</p>
<p>In the meantime, let’s hop to the next section and take a look at how to initialize our freshly-minted semaphores.</p>
<!-- ======================================================= -->
<!-- Controlling semaphores -->
<!-- ======================================================= -->
<h2 data-number="8.2" id="controlling-your-semaphores-with-semctl"><span class="header-section-number">8.2</span> Controlling your semaphores with <code>semctl()</code></h2>
<p>Once you have created your semaphore sets, you have to initialize them to a positive value to show that the resource is available to use. The function <code>semctl()</code> allows you to do atomic value changes to individual semaphores or complete sets of semaphores.</p>
<div class="sourceCode" id="cb42"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb42-1"><a href="semaphores.html#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> semctl<span class="op">(</span><span class="dt">int</span> semid<span class="op">,</span> <span class="dt">int</span> semnum<span class="op">,</span> <span class="dt">int</span> cmd<span class="op">,</span> <span class="op">...</span> <span class="co">/*arg*/</span><span class="op">);</span></span></code></pre></div>
<p><code>semid</code> is the semaphore set id that you get from your call to <code>semget()</code>, earlier. <code>semnum</code> is the ID of the semaphore that you wish to manipulate the value of. <code>cmd</code> is what you wish to do with the semaphore in question. The last “argument”, “<code>arg</code>”, if required, needs to be a <code>union semun</code>, which will be defined by you in your code to be one of these:</p>
<div class="sourceCode" id="cb43"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb43-1"><a href="semaphores.html#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="kw">union</span> semun <span class="op">{</span></span>
<span id="cb43-2"><a href="semaphores.html#cb43-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> val<span class="op">;</span>               <span class="co">/* used for SETVAL only */</span></span>
<span id="cb43-3"><a href="semaphores.html#cb43-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">struct</span> semid_ds <span class="op">*</span>buf<span class="op">;</span>  <span class="co">/* used for IPC_STAT and IPC_SET */</span></span>
<span id="cb43-4"><a href="semaphores.html#cb43-4" aria-hidden="true" tabindex="-1"></a>    ushort <span class="op">*</span>array<span class="op">;</span>         <span class="co">/* used for GETALL and SETALL */</span></span>
<span id="cb43-5"><a href="semaphores.html#cb43-5" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span></code></pre></div>
<p>(Note that <code>union semun</code> is now defined in the header files of modern Linux systems. However, I don’t know what feature test macro to use to determine this, so only define this union if your system doesn’t already. Read the docs for <code>semctl()</code> for more information.)</p>
<p>The various fields in the <code>union semun</code> are used depending on the value of the <code>cmd</code> parameter to <code>semctl()</code> (a partial list follows—see your local man page for more):</p>
<table>
<colgroup>
<col style="width: 14%" />
<col style="width: 85%" />
</colgroup>
<thead>
<tr class="header">
<th style="text-align: center;"><code>cmd</code></th>
<th>Effect</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;"><code>SETVAL</code></td>
<td>Set the value of the specified semaphore to the value in the <code>val</code> member of the passed-in <code>union semun</code>.</td>
</tr>
<tr class="even">
<td style="text-align: center;"><code>GETVAL</code></td>
<td>Return the value of the given semaphore.</td>
</tr>
<tr class="odd">
<td style="text-align: center;"><code>SETALL</code></td>
<td>Set the values of all the semaphores in the set to the values in the array pointed to by the <code>array</code> member of the passed-in <code>union semun</code>. The <code>semnum</code> parameter to <code>semctl()</code> isn’t used.&lt;</td>
</tr>
<tr class="even">
<td style="text-align: center;"><code>GETALL</code></td>
<td>Gets the values of all the semaphores in the set and stores them in the array pointed to by the <code>array</code> member of the passed-in <code>union semun</code>. The <code>semnum</code> parameter to <code>semctl()</code> isn’t used.</td>
</tr>
<tr class="odd">
<td style="text-align: center;"><code>IPC_RMID</code></td>
<td>Remove the specified semaphore set from the system. The <code>semnum</code> parameter is ignored.</td>
</tr>
<tr class="even">
<td style="text-align: center;"><code>IPC_STAT</code></td>
<td>Load status information about the semaphore set into the <code>struct semid_ds</code> structure pointed to by the <code>buf</code> member of the <code>union semun</code>.</td>
</tr>
</tbody>
</table>
<p>For the curious, here are the (abbreviated) contents of the <code>struct semid_ds</code> that is used in the <code>union semun</code>:</p>
<div class="sourceCode" id="cb44"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb44-1"><a href="semaphores.html#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> semid_ds <span class="op">{</span></span>
<span id="cb44-2"><a href="semaphores.html#cb44-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">struct</span> ipc_perm sem_perm<span class="op">;</span>  <span class="co">/* Ownership and permissions</span></span>
<span id="cb44-3"><a href="semaphores.html#cb44-3" aria-hidden="true" tabindex="-1"></a><span class="co">    time_t          sem_otime; /* Last semop time */</span></span>
<span id="cb44-4"><a href="semaphores.html#cb44-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">time_t</span>          sem_ctime<span class="op">;</span> <span class="co">/* Last change time */</span></span>
<span id="cb44-5"><a href="semaphores.html#cb44-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">unsigned</span> <span class="dt">short</span>  sem_nsems<span class="op">;</span> <span class="co">/* No. of semaphores in set */</span></span>
<span id="cb44-6"><a href="semaphores.html#cb44-6" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span></code></pre></div>
<p>We’ll use that <code>sem_otime</code> member later on when we write our <code>initsem()</code> in the sample code, below.</p>
<!-- ======================================================= -->
<!-- semop(): Atomic power! -->
<!-- ======================================================= -->
<h2 data-number="8.3" id="semop-atomic-power"><span class="header-section-number">8.3</span> <code>semop()</code>: Atomic power!</h2>
<p>All operations that set, get, or test-n-set a semaphore use the <code>semop()</code> system call. This system call is general purpose, and its functionality is dictated by a structure that is passed to it, <code>struct sembuf</code>:</p>
<div class="sourceCode" id="cb45"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb45-1"><a href="semaphores.html#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="co">/* Warning! Members might not be in this order! */</span></span>
<span id="cb45-2"><a href="semaphores.html#cb45-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-3"><a href="semaphores.html#cb45-3" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> sembuf <span class="op">{</span></span>
<span id="cb45-4"><a href="semaphores.html#cb45-4" aria-hidden="true" tabindex="-1"></a>    ushort sem_num<span class="op">;</span></span>
<span id="cb45-5"><a href="semaphores.html#cb45-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">short</span> sem_op<span class="op">;</span></span>
<span id="cb45-6"><a href="semaphores.html#cb45-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">short</span> sem_flg<span class="op">;</span></span>
<span id="cb45-7"><a href="semaphores.html#cb45-7" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span></code></pre></div>
<p>Of course, <code>sem_num</code> is the number of the semaphore in the set that you want to manipulate. Then, <code>sem_op</code> is what you want to do with that semaphore. This takes on different meanings, depending on whether <code>sem_op</code> is positive, negative, or zero, as shown in the following table:</p>
<table>
<colgroup>
<col style="width: 11%" />
<col style="width: 88%" />
</colgroup>
<thead>
<tr class="header">
<th style="text-align: center;"><code>sem_op</code></th>
<th>What happens</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">Negative</td>
<td>Allocate resources. Block the calling process until the value of the semaphore is greater than or equal to the absolute value of <code>sem_op</code>. (That is, wait until enough resources have been freed by other processes for this one to allocate.) Then add (effectively subtract, since it’s negative) the value of <code>sem_op</code> to the semaphore’s value.</td>
</tr>
<tr class="even">
<td style="text-align: center;">Positive</td>
<td>Release resources. The value of <code>sem_op</code> is added to the semaphore’s value.</td>
</tr>
<tr class="odd">
<td style="text-align: center;">Zero</td>
<td>This process will wait until the semaphore in question reaches 0.</td>
</tr>
</tbody>
</table>
<p>So, basically, what you do is load up a <code>struct sembuf</code> with whatever values you want, then call <code>semop()</code>, like this:</p>
<!-- BOOKMARK -->
<div class="sourceCode" id="cb46"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb46-1"><a href="semaphores.html#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> semop<span class="op">(</span><span class="dt">int</span> semid<span class="op">,</span> <span class="kw">struct</span> sembuf <span class="op">*</span>sops<span class="op">,</span></span>
<span id="cb46-2"><a href="semaphores.html#cb46-2" aria-hidden="true" tabindex="-1"></a>          <span class="dt">unsigned</span> <span class="dt">int</span> nsops<span class="op">);</span></span></code></pre></div>
<p>The <code>semid</code> argument is the number obtained from the call to <code>semget()</code>. Next is <code>sops</code>, which is a pointer to the <code>struct sembuf</code> that you filled with your semaphore commands. If you want, though, you can make an array of <code>struct sembuf</code>s in order to do a whole bunch of semaphore operations at the same time. The way <code>semop()</code> knows that you’re doing this is the <code>nsop</code> argument, which tells how many <code>struct sembuf</code>s you’re sending it. If you only have one, well, put <code>1</code> as this argument.</p>
<p>One field in the <code>struct sembuf</code> that I haven’t mentioned is the <code>sem_flg</code> field which allows the program to specify flags to further modify the effects of the <code>semop()</code> call.</p>
<p>One of these flags is <code>IPC_NOWAIT</code> which, as the name suggests, causes the call to <code>semop()</code> to return with error <code>EAGAIN</code> if it encounters a situation where it would normally block. This is good for situations where you might want to “poll” to see if you can allocate a resource.</p>
<p>Another very useful flag is the <code>SEM_UNDO</code> flag. This causes <code>semop()</code> to record, in a way, the change made to the semaphore. When the program exits, the kernel will automatically undo all changes that were marked with the <code>SEM_UNDO</code> flag. Of course, your program should do its best to deallocate any resources it marks using the semaphore, but sometimes this isn’t possible when your program gets a <code>SIGKILL</code> or some other awful crash happens.</p>
<!-- ======================================================= -->
<!-- Destroying a semaphore -->
<!-- ======================================================= -->
<h2 data-number="8.4" id="destroying-a-semaphore"><span class="header-section-number">8.4</span> Destroying a semaphore</h2>
<p>There are two ways to get rid of a semaphore: one is to use the Unix command <code>ipcrm</code>. The other is through a call to <code>semctl()</code> with the <code>cmd</code> set to <code>IPC_RMID</code>.</p>
<p>Basically, you want to call <code>semctl()</code> and set <code>semid</code> to the semaphore ID you want to axe. The <code>cmd</code> should be set to <code>IPC_RMID</code>, which tells <code>semctl()</code> to remove this semaphore set. The parameter <code>semnum</code> has no meaning in the <code>IPC_RMID</code> context and can just be set to zero.</p>
<p>Here’s an example call to torch a semaphore set:</p>
<div class="sourceCode" id="cb47"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb47-1"><a href="semaphores.html#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> semid<span class="op">;</span> </span>
<span id="cb47-2"><a href="semaphores.html#cb47-2" aria-hidden="true" tabindex="-1"></a><span class="op">.</span></span>
<span id="cb47-3"><a href="semaphores.html#cb47-3" aria-hidden="true" tabindex="-1"></a><span class="op">.</span></span>
<span id="cb47-4"><a href="semaphores.html#cb47-4" aria-hidden="true" tabindex="-1"></a>semid <span class="op">=</span> semget<span class="op">(...);</span></span>
<span id="cb47-5"><a href="semaphores.html#cb47-5" aria-hidden="true" tabindex="-1"></a><span class="op">.</span></span>
<span id="cb47-6"><a href="semaphores.html#cb47-6" aria-hidden="true" tabindex="-1"></a><span class="op">.</span></span>
<span id="cb47-7"><a href="semaphores.html#cb47-7" aria-hidden="true" tabindex="-1"></a>semctl<span class="op">(</span>semid<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> IPC_RMID<span class="op">);</span></span></code></pre></div>
<p>Easy peasy.</p>
<!-- ======================================================= -->
<!-- Semaphore: Sample Programs -->
<!-- ======================================================= -->
<h2 data-number="8.5" id="sample-programs"><span class="header-section-number">8.5</span> Sample Programs</h2>
<p>There are two of them. The first, <code>semdemo.c</code>, creates the semaphore if necessary, and performs some pretend file locking on it in a demo very much like that in the <a href="flocking.html#flocking">File Locking</a> document. The second program, <code>semrm.c</code> is used to destroy the semaphore (again, <code>ipcrm</code> could be used to accomplish this.)</p>
<p>The idea is to run run <code>semdemo.c</code> in a few windows and see how all the processes interact. When you’re done, use <code>semrm.c</code> to remove the semaphore. You could also try removing the semaphore while running <code>semdemo.c</code> just to see what kinds of errors are generated.</p>
<p>Here’s <a href="https://beej.us/guide/bgipc/source/examples/semdemo.c"><code>semdemo.c</code></a><a href="footnotes.html#fn34" class="footnote-ref" id="fnref34" role="doc-noteref"><sup>34</sup></a>, including a function named <code>initsem()</code> that gets around the semaphore race conditions, Stevens-style:</p>
<div class="sourceCode" id="cb48"><pre class="sourceCode numberSource c numberLines"><code class="sourceCode c"><span id="cb48-1"><a href="semaphores.html#cb48-1"></a><span class="pp">#include </span><span class="im">&lt;stdlib.h&gt;</span></span>
<span id="cb48-2"><a href="semaphores.html#cb48-2"></a><span class="pp">#include </span><span class="im">&lt;unistd.h&gt;</span></span>
<span id="cb48-3"><a href="semaphores.html#cb48-3"></a><span class="pp">#include </span><span class="im">&lt;errno.h&gt;</span></span>
<span id="cb48-4"><a href="semaphores.html#cb48-4"></a><span class="pp">#include </span><span class="im">&lt;sys/types.h&gt;</span></span>
<span id="cb48-5"><a href="semaphores.html#cb48-5"></a><span class="pp">#include </span><span class="im">&lt;sys/ipc.h&gt;</span></span>
<span id="cb48-6"><a href="semaphores.html#cb48-6"></a><span class="pp">#include </span><span class="im">&lt;sys/sem.h&gt;</span></span>
<span id="cb48-7"><a href="semaphores.html#cb48-7"></a></span>
<span id="cb48-8"><a href="semaphores.html#cb48-8"></a><span class="pp">#define MAX_RETRIES </span><span class="dv">10</span></span>
<span id="cb48-9"><a href="semaphores.html#cb48-9"></a></span>
<span id="cb48-10"><a href="semaphores.html#cb48-10"></a><span class="pp">#ifdef NEED_SEMUN</span></span>
<span id="cb48-11"><a href="semaphores.html#cb48-11"></a><span class="co">/* Defined in sys/sem.h as required by POSIX now */</span></span>
<span id="cb48-12"><a href="semaphores.html#cb48-12"></a><span class="kw">union</span> semun <span class="op">{</span></span>
<span id="cb48-13"><a href="semaphores.html#cb48-13"></a>    <span class="dt">int</span> val<span class="op">;</span></span>
<span id="cb48-14"><a href="semaphores.html#cb48-14"></a>    <span class="kw">struct</span> semid_ds <span class="op">*</span>buf<span class="op">;</span></span>
<span id="cb48-15"><a href="semaphores.html#cb48-15"></a>    ushort <span class="op">*</span>array<span class="op">;</span></span>
<span id="cb48-16"><a href="semaphores.html#cb48-16"></a><span class="op">};</span></span>
<span id="cb48-17"><a href="semaphores.html#cb48-17"></a><span class="pp">#endif</span></span>
<span id="cb48-18"><a href="semaphores.html#cb48-18"></a></span>
<span id="cb48-19"><a href="semaphores.html#cb48-19"></a><span class="co">/*</span></span>
<span id="cb48-20"><a href="semaphores.html#cb48-20"></a><span class="co">** initsem() -- more-than-inspired by W. Richard Stevens&#39; UNIX Network</span></span>
<span id="cb48-21"><a href="semaphores.html#cb48-21"></a><span class="co">** Programming 2nd edition, volume 2, lockvsem.c, page 295.</span></span>
<span id="cb48-22"><a href="semaphores.html#cb48-22"></a><span class="co">*/</span></span>
<span id="cb48-23"><a href="semaphores.html#cb48-23"></a><span class="dt">int</span> initsem<span class="op">(</span>key_t key<span class="op">,</span> <span class="dt">int</span> nsems<span class="op">)</span>  <span class="co">/* key from ftok() */</span></span>
<span id="cb48-24"><a href="semaphores.html#cb48-24"></a><span class="op">{</span></span>
<span id="cb48-25"><a href="semaphores.html#cb48-25"></a>    <span class="dt">int</span> i<span class="op">;</span></span>
<span id="cb48-26"><a href="semaphores.html#cb48-26"></a>    <span class="kw">union</span> semun arg<span class="op">;</span></span>
<span id="cb48-27"><a href="semaphores.html#cb48-27"></a>    <span class="kw">struct</span> semid_ds buf<span class="op">;</span></span>
<span id="cb48-28"><a href="semaphores.html#cb48-28"></a>    <span class="kw">struct</span> sembuf sb<span class="op">;</span></span>
<span id="cb48-29"><a href="semaphores.html#cb48-29"></a>    <span class="dt">int</span> semid<span class="op">;</span></span>
<span id="cb48-30"><a href="semaphores.html#cb48-30"></a></span>
<span id="cb48-31"><a href="semaphores.html#cb48-31"></a>    semid <span class="op">=</span> semget<span class="op">(</span>key<span class="op">,</span> nsems<span class="op">,</span> IPC_CREAT <span class="op">|</span> IPC_EXCL <span class="op">|</span> <span class="bn">0666</span><span class="op">);</span></span>
<span id="cb48-32"><a href="semaphores.html#cb48-32"></a></span>
<span id="cb48-33"><a href="semaphores.html#cb48-33"></a>    <span class="cf">if</span> <span class="op">(</span>semid <span class="op">&gt;=</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span> <span class="co">/* we got it first */</span></span>
<span id="cb48-34"><a href="semaphores.html#cb48-34"></a>            sb<span class="op">.</span>sem_op <span class="op">=</span> <span class="dv">1</span><span class="op">;</span> sb<span class="op">.</span>sem_flg <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb48-35"><a href="semaphores.html#cb48-35"></a>            arg<span class="op">.</span>val <span class="op">=</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb48-36"><a href="semaphores.html#cb48-36"></a></span>
<span id="cb48-37"><a href="semaphores.html#cb48-37"></a>            printf<span class="op">(</span><span class="st">&quot;press return</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">);</span> getchar<span class="op">();</span></span>
<span id="cb48-38"><a href="semaphores.html#cb48-38"></a></span>
<span id="cb48-39"><a href="semaphores.html#cb48-39"></a>            <span class="cf">for</span><span class="op">(</span>sb<span class="op">.</span>sem_num <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> sb<span class="op">.</span>sem_num <span class="op">&lt;</span> nsems<span class="op">;</span> sb<span class="op">.</span>sem_num<span class="op">++)</span> <span class="op">{</span> </span>
<span id="cb48-40"><a href="semaphores.html#cb48-40"></a>                    <span class="co">/* do a semop() to &quot;free&quot; the semaphores. */</span></span>
<span id="cb48-41"><a href="semaphores.html#cb48-41"></a>                    <span class="co">/* this sets the sem_otime field, as needed below. */</span></span>
<span id="cb48-42"><a href="semaphores.html#cb48-42"></a>                    <span class="cf">if</span> <span class="op">(</span>semop<span class="op">(</span>semid<span class="op">,</span> <span class="op">&amp;</span>sb<span class="op">,</span> <span class="dv">1</span><span class="op">)</span> <span class="op">==</span> <span class="op">-</span><span class="dv">1</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb48-43"><a href="semaphores.html#cb48-43"></a>                            <span class="dt">int</span> e <span class="op">=</span> errno<span class="op">;</span></span>
<span id="cb48-44"><a href="semaphores.html#cb48-44"></a>                            semctl<span class="op">(</span>semid<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> IPC_RMID<span class="op">);</span> <span class="co">/* clean up */</span></span>
<span id="cb48-45"><a href="semaphores.html#cb48-45"></a>                            errno <span class="op">=</span> e<span class="op">;</span></span>
<span id="cb48-46"><a href="semaphores.html#cb48-46"></a>                            <span class="cf">return</span> <span class="op">-</span><span class="dv">1</span><span class="op">;</span> <span class="co">/* error, check errno */</span></span>
<span id="cb48-47"><a href="semaphores.html#cb48-47"></a>                    <span class="op">}</span></span>
<span id="cb48-48"><a href="semaphores.html#cb48-48"></a>            <span class="op">}</span></span>
<span id="cb48-49"><a href="semaphores.html#cb48-49"></a></span>
<span id="cb48-50"><a href="semaphores.html#cb48-50"></a>    <span class="op">}</span> <span class="cf">else</span> <span class="cf">if</span> <span class="op">(</span>errno <span class="op">==</span> EEXIST<span class="op">)</span> <span class="op">{</span> <span class="co">/* someone else got it first */</span></span>
<span id="cb48-51"><a href="semaphores.html#cb48-51"></a>            <span class="dt">int</span> ready <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb48-52"><a href="semaphores.html#cb48-52"></a></span>
<span id="cb48-53"><a href="semaphores.html#cb48-53"></a>            semid <span class="op">=</span> semget<span class="op">(</span>key<span class="op">,</span> nsems<span class="op">,</span> <span class="dv">0</span><span class="op">);</span> <span class="co">/* get the id */</span></span>
<span id="cb48-54"><a href="semaphores.html#cb48-54"></a>            <span class="cf">if</span> <span class="op">(</span>semid <span class="op">&lt;</span> <span class="dv">0</span><span class="op">)</span> <span class="cf">return</span> semid<span class="op">;</span> <span class="co">/* error, check errno */</span></span>
<span id="cb48-55"><a href="semaphores.html#cb48-55"></a></span>
<span id="cb48-56"><a href="semaphores.html#cb48-56"></a>            <span class="co">/* wait for other process to initialize the semaphore: */</span></span>
<span id="cb48-57"><a href="semaphores.html#cb48-57"></a>            arg<span class="op">.</span>buf <span class="op">=</span> <span class="op">&amp;</span>buf<span class="op">;</span></span>
<span id="cb48-58"><a href="semaphores.html#cb48-58"></a>            <span class="cf">for</span><span class="op">(</span>i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> MAX_RETRIES <span class="op">&amp;&amp;</span> <span class="op">!</span>ready<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb48-59"><a href="semaphores.html#cb48-59"></a>                    semctl<span class="op">(</span>semid<span class="op">,</span> nsems<span class="op">-</span><span class="dv">1</span><span class="op">,</span> IPC_STAT<span class="op">,</span> arg<span class="op">);</span></span>
<span id="cb48-60"><a href="semaphores.html#cb48-60"></a>                    <span class="cf">if</span> <span class="op">(</span>arg<span class="op">.</span>buf<span class="op">-&gt;</span>sem_otime <span class="op">!=</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb48-61"><a href="semaphores.html#cb48-61"></a>                            ready <span class="op">=</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb48-62"><a href="semaphores.html#cb48-62"></a>                    <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb48-63"><a href="semaphores.html#cb48-63"></a>                            sleep<span class="op">(</span><span class="dv">1</span><span class="op">);</span></span>
<span id="cb48-64"><a href="semaphores.html#cb48-64"></a>                    <span class="op">}</span></span>
<span id="cb48-65"><a href="semaphores.html#cb48-65"></a>            <span class="op">}</span></span>
<span id="cb48-66"><a href="semaphores.html#cb48-66"></a>            <span class="cf">if</span> <span class="op">(!</span>ready<span class="op">)</span> <span class="op">{</span></span>
<span id="cb48-67"><a href="semaphores.html#cb48-67"></a>                    errno <span class="op">=</span> ETIME<span class="op">;</span></span>
<span id="cb48-68"><a href="semaphores.html#cb48-68"></a>                    <span class="cf">return</span> <span class="op">-</span><span class="dv">1</span><span class="op">;</span></span>
<span id="cb48-69"><a href="semaphores.html#cb48-69"></a>            <span class="op">}</span></span>
<span id="cb48-70"><a href="semaphores.html#cb48-70"></a>    <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb48-71"><a href="semaphores.html#cb48-71"></a>            <span class="cf">return</span> semid<span class="op">;</span> <span class="co">/* error, check errno */</span></span>
<span id="cb48-72"><a href="semaphores.html#cb48-72"></a>    <span class="op">}</span></span>
<span id="cb48-73"><a href="semaphores.html#cb48-73"></a></span>
<span id="cb48-74"><a href="semaphores.html#cb48-74"></a>    <span class="cf">return</span> semid<span class="op">;</span></span>
<span id="cb48-75"><a href="semaphores.html#cb48-75"></a><span class="op">}</span></span>
<span id="cb48-76"><a href="semaphores.html#cb48-76"></a></span>
<span id="cb48-77"><a href="semaphores.html#cb48-77"></a><span class="dt">int</span> main<span class="op">(</span><span class="dt">void</span><span class="op">)</span></span>
<span id="cb48-78"><a href="semaphores.html#cb48-78"></a><span class="op">{</span></span>
<span id="cb48-79"><a href="semaphores.html#cb48-79"></a>    key_t key<span class="op">;</span></span>
<span id="cb48-80"><a href="semaphores.html#cb48-80"></a>    <span class="dt">int</span> semid<span class="op">;</span></span>
<span id="cb48-81"><a href="semaphores.html#cb48-81"></a>    <span class="kw">struct</span> sembuf sb<span class="op">;</span></span>
<span id="cb48-82"><a href="semaphores.html#cb48-82"></a>    </span>
<span id="cb48-83"><a href="semaphores.html#cb48-83"></a>    sb<span class="op">.</span>sem_num <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb48-84"><a href="semaphores.html#cb48-84"></a>    sb<span class="op">.</span>sem_op <span class="op">=</span> <span class="op">-</span><span class="dv">1</span><span class="op">;</span>  <span class="co">/* set to allocate resource */</span></span>
<span id="cb48-85"><a href="semaphores.html#cb48-85"></a>    sb<span class="op">.</span>sem_flg <span class="op">=</span> SEM_UNDO<span class="op">;</span></span>
<span id="cb48-86"><a href="semaphores.html#cb48-86"></a></span>
<span id="cb48-87"><a href="semaphores.html#cb48-87"></a>    <span class="cf">if</span> <span class="op">((</span>key <span class="op">=</span> ftok<span class="op">(</span><span class="st">&quot;semdemo.c&quot;</span><span class="op">,</span> <span class="ch">&#39;J&#39;</span><span class="op">))</span> <span class="op">==</span> <span class="op">-</span><span class="dv">1</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb48-88"><a href="semaphores.html#cb48-88"></a>            perror<span class="op">(</span><span class="st">&quot;ftok&quot;</span><span class="op">);</span></span>
<span id="cb48-89"><a href="semaphores.html#cb48-89"></a>            exit<span class="op">(</span><span class="dv">1</span><span class="op">);</span></span>
<span id="cb48-90"><a href="semaphores.html#cb48-90"></a>    <span class="op">}</span></span>
<span id="cb48-91"><a href="semaphores.html#cb48-91"></a></span>
<span id="cb48-92"><a href="semaphores.html#cb48-92"></a>    <span class="co">/* grab the semaphore set created by seminit.c: */</span></span>
<span id="cb48-93"><a href="semaphores.html#cb48-93"></a>    <span class="cf">if</span> <span class="op">((</span>semid <span class="op">=</span> initsem<span class="op">(</span>key<span class="op">,</span> <span class="dv">1</span><span class="op">))</span> <span class="op">==</span> <span class="op">-</span><span class="dv">1</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb48-94"><a href="semaphores.html#cb48-94"></a>            perror<span class="op">(</span><span class="st">&quot;initsem&quot;</span><span class="op">);</span></span>
<span id="cb48-95"><a href="semaphores.html#cb48-95"></a>            exit<span class="op">(</span><span class="dv">1</span><span class="op">);</span></span>
<span id="cb48-96"><a href="semaphores.html#cb48-96"></a>    <span class="op">}</span></span>
<span id="cb48-97"><a href="semaphores.html#cb48-97"></a></span>
<span id="cb48-98"><a href="semaphores.html#cb48-98"></a>    printf<span class="op">(</span><span class="st">&quot;Press return to lock: &quot;</span><span class="op">);</span></span>
<span id="cb48-99"><a href="semaphores.html#cb48-99"></a>    getchar<span class="op">();</span></span>
<span id="cb48-100"><a href="semaphores.html#cb48-100"></a>    printf<span class="op">(</span><span class="st">&quot;Trying to lock...</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">);</span></span>
<span id="cb48-101"><a href="semaphores.html#cb48-101"></a></span>
<span id="cb48-102"><a href="semaphores.html#cb48-102"></a>    <span class="cf">if</span> <span class="op">(</span>semop<span class="op">(</span>semid<span class="op">,</span> <span class="op">&amp;</span>sb<span class="op">,</span> <span class="dv">1</span><span class="op">)</span> <span class="op">==</span> <span class="op">-</span><span class="dv">1</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb48-103"><a href="semaphores.html#cb48-103"></a>            perror<span class="op">(</span><span class="st">&quot;semop&quot;</span><span class="op">);</span></span>
<span id="cb48-104"><a href="semaphores.html#cb48-104"></a>            exit<span class="op">(</span><span class="dv">1</span><span class="op">);</span></span>
<span id="cb48-105"><a href="semaphores.html#cb48-105"></a>    <span class="op">}</span></span>
<span id="cb48-106"><a href="semaphores.html#cb48-106"></a></span>
<span id="cb48-107"><a href="semaphores.html#cb48-107"></a>    printf<span class="op">(</span><span class="st">&quot;Locked.</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">);</span></span>
<span id="cb48-108"><a href="semaphores.html#cb48-108"></a>    printf<span class="op">(</span><span class="st">&quot;Press return to unlock: &quot;</span><span class="op">);</span></span>
<span id="cb48-109"><a href="semaphores.html#cb48-109"></a>    getchar<span class="op">();</span></span>
<span id="cb48-110"><a href="semaphores.html#cb48-110"></a></span>
<span id="cb48-111"><a href="semaphores.html#cb48-111"></a>    sb<span class="op">.</span>sem_op <span class="op">=</span> <span class="dv">1</span><span class="op">;</span> <span class="co">/* free resource */</span></span>
<span id="cb48-112"><a href="semaphores.html#cb48-112"></a>    <span class="cf">if</span> <span class="op">(</span>semop<span class="op">(</span>semid<span class="op">,</span> <span class="op">&amp;</span>sb<span class="op">,</span> <span class="dv">1</span><span class="op">)</span> <span class="op">==</span> <span class="op">-</span><span class="dv">1</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb48-113"><a href="semaphores.html#cb48-113"></a>            perror<span class="op">(</span><span class="st">&quot;semop&quot;</span><span class="op">);</span></span>
<span id="cb48-114"><a href="semaphores.html#cb48-114"></a>            exit<span class="op">(</span><span class="dv">1</span><span class="op">);</span></span>
<span id="cb48-115"><a href="semaphores.html#cb48-115"></a>    <span class="op">}</span></span>
<span id="cb48-116"><a href="semaphores.html#cb48-116"></a></span>
<span id="cb48-117"><a href="semaphores.html#cb48-117"></a>    printf<span class="op">(</span><span class="st">&quot;Unlocked</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">);</span></span>
<span id="cb48-118"><a href="semaphores.html#cb48-118"></a></span>
<span id="cb48-119"><a href="semaphores.html#cb48-119"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb48-120"><a href="semaphores.html#cb48-120"></a><span class="op">}</span></span></code></pre></div>
<p>Here’s <a href="https://beej.us/guide/bgipc/source/examples/semrm.c"><code>semrm.c</code></a><a href="footnotes.html#fn35" class="footnote-ref" id="fnref35" role="doc-noteref"><sup>35</sup></a> for removing the semaphore when you’re done:</p>
<div class="sourceCode" id="cb49"><pre class="sourceCode numberSource c numberLines"><code class="sourceCode c"><span id="cb49-1"><a href="semaphores.html#cb49-1"></a><span class="pp">#include </span><span class="im">&lt;stdlib.h&gt;</span></span>
<span id="cb49-2"><a href="semaphores.html#cb49-2"></a><span class="pp">#include </span><span class="im">&lt;errno.h&gt;</span></span>
<span id="cb49-3"><a href="semaphores.html#cb49-3"></a><span class="pp">#include </span><span class="im">&lt;sys/types.h&gt;</span></span>
<span id="cb49-4"><a href="semaphores.html#cb49-4"></a><span class="pp">#include </span><span class="im">&lt;sys/ipc.h&gt;</span></span>
<span id="cb49-5"><a href="semaphores.html#cb49-5"></a><span class="pp">#include </span><span class="im">&lt;sys/sem.h&gt;</span></span>
<span id="cb49-6"><a href="semaphores.html#cb49-6"></a></span>
<span id="cb49-7"><a href="semaphores.html#cb49-7"></a><span class="dt">int</span> main<span class="op">(</span><span class="dt">void</span><span class="op">)</span></span>
<span id="cb49-8"><a href="semaphores.html#cb49-8"></a><span class="op">{</span></span>
<span id="cb49-9"><a href="semaphores.html#cb49-9"></a>    key_t key<span class="op">;</span></span>
<span id="cb49-10"><a href="semaphores.html#cb49-10"></a>    <span class="dt">int</span> semid<span class="op">;</span></span>
<span id="cb49-11"><a href="semaphores.html#cb49-11"></a>    <span class="kw">union</span> semun arg<span class="op">;</span></span>
<span id="cb49-12"><a href="semaphores.html#cb49-12"></a></span>
<span id="cb49-13"><a href="semaphores.html#cb49-13"></a>    <span class="cf">if</span> <span class="op">((</span>key <span class="op">=</span> ftok<span class="op">(</span><span class="st">&quot;semdemo.c&quot;</span><span class="op">,</span> <span class="ch">&#39;J&#39;</span><span class="op">))</span> <span class="op">==</span> <span class="op">-</span><span class="dv">1</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb49-14"><a href="semaphores.html#cb49-14"></a>            perror<span class="op">(</span><span class="st">&quot;ftok&quot;</span><span class="op">);</span></span>
<span id="cb49-15"><a href="semaphores.html#cb49-15"></a>            exit<span class="op">(</span><span class="dv">1</span><span class="op">);</span></span>
<span id="cb49-16"><a href="semaphores.html#cb49-16"></a>    <span class="op">}</span></span>
<span id="cb49-17"><a href="semaphores.html#cb49-17"></a></span>
<span id="cb49-18"><a href="semaphores.html#cb49-18"></a>    <span class="co">/* grab the semaphore set created by seminit.c: */</span></span>
<span id="cb49-19"><a href="semaphores.html#cb49-19"></a>    <span class="cf">if</span> <span class="op">((</span>semid <span class="op">=</span> semget<span class="op">(</span>key<span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">0</span><span class="op">))</span> <span class="op">==</span> <span class="op">-</span><span class="dv">1</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb49-20"><a href="semaphores.html#cb49-20"></a>            perror<span class="op">(</span><span class="st">&quot;semget&quot;</span><span class="op">);</span></span>
<span id="cb49-21"><a href="semaphores.html#cb49-21"></a>            exit<span class="op">(</span><span class="dv">1</span><span class="op">);</span></span>
<span id="cb49-22"><a href="semaphores.html#cb49-22"></a>    <span class="op">}</span></span>
<span id="cb49-23"><a href="semaphores.html#cb49-23"></a></span>
<span id="cb49-24"><a href="semaphores.html#cb49-24"></a>    <span class="co">/* remove it: */</span></span>
<span id="cb49-25"><a href="semaphores.html#cb49-25"></a>    <span class="cf">if</span> <span class="op">(</span>semctl<span class="op">(</span>semid<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> IPC_RMID<span class="op">,</span> <span class="dv">0</span><span class="op">)</span> <span class="op">==</span> <span class="op">-</span><span class="dv">1</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb49-26"><a href="semaphores.html#cb49-26"></a>            perror<span class="op">(</span><span class="st">&quot;semctl&quot;</span><span class="op">);</span></span>
<span id="cb49-27"><a href="semaphores.html#cb49-27"></a>            exit<span class="op">(</span><span class="dv">1</span><span class="op">);</span></span>
<span id="cb49-28"><a href="semaphores.html#cb49-28"></a>    <span class="op">}</span></span>
<span id="cb49-29"><a href="semaphores.html#cb49-29"></a></span>
<span id="cb49-30"><a href="semaphores.html#cb49-30"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb49-31"><a href="semaphores.html#cb49-31"></a><span class="op">}</span></span></code></pre></div>
<p>Isn’t that fun! I’m sure you’ll give up Quake<a href="footnotes.html#fn36" class="footnote-ref" id="fnref36" role="doc-noteref"><sup>36</sup></a> just to play with this semaphore stuff all day long!</p>
<!-- ======================================================= -->
<!-- Semaphore summary -->
<!-- ======================================================= -->
<h2 data-number="8.6" id="summary-4"><span class="header-section-number">8.6</span> Summary</h2>
<p>I might have understated the usefulness of semaphores. I assure you, they’re very very very useful in a concurrency situation. They’re often faster than regular file locks, too. Also, you can use them on other things that aren’t files, such as <a href="shm.html#shm">Shared Memory Segments</a>! In fact, it is sometimes hard to live without them, quite frankly.</p>
<p>Whenever you have multiple processes running through a critical section of code, man, you need semaphores. You have zillions of them—you might as well use ’em.</p>
<!-- Beej's guide to IPC

# vim: ts=4:sw=4:nosi:et:tw=72
-->
<!-- ======================================================= -->
<!-- Shared Memory Segments -->
<!-- ======================================================= -->
<hr><div style="text-align:center"><span><a href="mq.html">Prev</a> | </span><a href="index.html">Contents</a><span> | <a href="shm.html">Next</a></span></div></body>
</html>
